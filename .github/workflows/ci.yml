name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  TERRAFORM_VERSION: 1.9.8
  ANSIBLE_CORE_VERSION: 2.15.0
  PYTHON_VERSION: 3.11

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: false

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Run TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --format compact

  terraform-security:
    name: Terraform Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform
          soft_fail: false

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          soft_fail: false
          quiet: false

  ansible-lint:
    name: Ansible Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible and ansible-lint
        run: |
          pip install ansible-core==${{ env.ANSIBLE_CORE_VERSION }} ansible-lint

      - name: Run ansible-lint
        run: |
          cd ansible
          ansible-lint playbooks/site.yml

      - name: Validate Ansible syntax
        run: |
          cd ansible
          ansible-playbook playbooks/site.yml --syntax-check

  ansible-security:
    name: Ansible Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ansible and ansible-lint
        run: pip install ansible ansible-lint

      - name: Run Ansible security checks
        run: |
          cd ansible
          ansible-lint --profile production playbooks/site.yml || true

  shell-scripts:
    name: Shell Script Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning

      - name: Check script permissions
        run: |
          echo "Checking script permissions..."
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              if [ ! -x "$script" ]; then
                echo "Warning: $script is not executable"
              else
                echo "âœ“ $script is executable"
              fi
            fi
          done

  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: '**/*.md'

  yaml-lint:
    name: YAML Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint -d "{extends: default, rules: {line-length: {max: 120}, indentation: {spaces: 2}}}" \
            ansible/ azure.yaml .github/

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required documentation files
        run: |
          required_files=(
            "README.md"
            "GETTING_STARTED.md"
            "docs/SETUP.md"
            "docs/DEPLOYMENT.md"
            "docs/SECURITY.md"
            "docs/TROUBLESHOOTING.md"
            ".env.example"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "Error: Missing required documentation files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          else
            echo "âœ“ All required documentation files present"
          fi

      - name: Check for broken links in markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
          base-branch: 'main'

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  integration-check:
    name: Integration Validation
    runs-on: ubuntu-latest
    needs: [terraform-validate, ansible-lint, shell-scripts]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify workflow files consistency
        run: |
          echo "Checking azd integration..."
          if [ ! -f "azure.yaml" ]; then
            echo "Error: azure.yaml not found"
            exit 1
          fi

          echo "Checking terraform outputs match ansible requirements..."
          # Verify that terraform outputs provide what ansible needs
          if ! grep -q "ansible_inventory" terraform/outputs.tf; then
            echo "Warning: Terraform may not output ansible inventory data"
          fi

          echo "âœ“ Integration checks passed"

      - name: Validate environment variables documentation
        run: |
          if [ ! -f ".env.example" ]; then
            echo "Error: .env.example file missing"
            exit 1
          fi

          # Check that required vars are documented
          required_vars=(
            "AZURE_SUBSCRIPTION_ID"
            "AZURE_TENANT_ID"
            "ARM_CLIENT_ID"
            "ARM_CLIENT_SECRET"
            "RKE2_TOKEN"
            "SSH_PUBLIC_KEY"
          )

          missing_vars=()
          for var in "${required_vars[@]}"; do
            if ! grep -q "$var" .env.example; then
              missing_vars+=("$var")
            fi
          done

          if [ ${#missing_vars[@]} -ne 0 ]; then
            echo "Error: Missing required variables in .env.example:"
            printf '%s\n' "${missing_vars[@]}"
            exit 1
          fi

          echo "âœ“ All required environment variables documented"

  all-checks-complete:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs:
      - terraform-validate
      - terraform-security
      - ansible-lint
      - ansible-security
      - shell-scripts
      - markdown-lint
      - yaml-lint
      - secrets-scan
      - documentation-check
      - dependency-check
      - integration-check

    steps:
      - name: Summary
        run: |
          echo "ðŸŽ‰ All CI checks passed successfully!"
          echo ""
          echo "Checks completed:"
          echo "  âœ“ Terraform validation and security"
          echo "  âœ“ Ansible linting and security"
          echo "  âœ“ Shell script validation"
          echo "  âœ“ Markdown linting"
          echo "  âœ“ YAML validation"
          echo "  âœ“ Secrets scanning"
          echo "  âœ“ Documentation verification"
          echo "  âœ“ Dependency security"
          echo "  âœ“ Integration validation"
